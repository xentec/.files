#!/bin/bash

# Expects a server to be mounted to your filesystem.
ssh_server=bastion:/srv/http/web/dump/scr
url="http://dump.aix0.eu/scr"
imageEncoding=".png"
videoEncoding=".webm"
name=`date "+%Y-%m-%d_%H-%M-%S"`
pidFile="/tmp/seen_record.pid"
nameFile="/tmp/seen_name"

function notify {
    if [ "$DISPLAY" ]; then
        awesome-notify "$1" "$2" $3 "$4"
    fi
}

function clipit {
    echo -n "$1" | xclip -selection clipboard
}

function upload {
    FILE=$1

    notify "seen: $FILE" "Uploading..." 3 "#7777FF"

    WHY=$(scp /tmp/$FILE $ssh_server/$FILE 2>&1)
    if [ $? -ne 0 ]; then
        WHY=$(tr '\r\n' '#' <<< $WHY | cut -f1 -d q'#')
        notify "seen: $FILE" "Failed: $WHY" 5 "#CC3333"
        exit
    fi

    notify "seen: $FILE" "Done: ${url}/$FILE" 5 "#33CC33"
}

function record {
    ffmpeg -f x11grab -s "${1}x${2}" -i ":0.0+${3},${4}" \
        -c:v libvpx -quality good -cpu-used 0 -b:v 2M -qmin 0 -qmax 32 -bufsize 1000k -threads 8 -an     \
        "/tmp/$5"
    E=$?
    echo $E > sig
    if [ $E -gt 0 ] && [ $E -ne 255 ]; then
        echo -e "\a" && echo -e "\a"
        rm "$5"
        rm "$pidFile"
        rm "$nameFile"
    fi
}

type=$1
if [ "$type" != "image"  ]; then
    if [ "$type" != "video"  ]; then
        type="image"
    fi
fi

if [ "$type" == "image" ]; then
    f=${name}${imageEncoding}

    eval `slop -b 3 -c 1.0,0.3,0.3`
    if [ "$(($W+$H))" != "0" ]; then
        maim -g "${W}x${H}+${X}+${Y}" "/tmp/$f"
    else
        exit 0
    fi

    notify "seen: $f" "Optimizing..." 3 "#EEAA00"
    optipng /tmp/$f

    upload $f
    clipit "${url}/$f"
    echo "${url}/$f"

    rm /tmp/$f
else
    f=${name}${videoEncoding}
    if [ -f "$pidFile" ]; then
        pkill -TERM -P `cat "$pidFile"`
        f=`cat "$nameFile"`
        echo -e "\a"
        rm "$pidFile" "$nameFile"

	upload $f
        clipit "${url}/$f"
        echo "${url}/$f"

        rm /tmp/$f
        exit 0
    fi
    eval `slop  -b 3 -c 1.0,0.3,1.0`
    if [ "$(($W+$H))" != "0" ]; then
        echo -e "\a"
        record ${W} ${H} ${X} ${Y} $f &
        pid=$!
        echo -n "$pid" > $pidFile
        echo -n "$f" > $nameFile
    fi
fi


